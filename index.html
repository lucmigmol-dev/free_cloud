<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Cloud - lucmigmol-dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; background: linear-gradient(to bottom, #f3f4f6, #ffffff); }
        .item { transition: all 0.2s; }
        .item:hover { transform: scale(1.02); background-color: #e5e7eb; }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-6 max-w-4xl">
        <h1 class="text-5xl font-bold text-center mb-10 text-indigo-800 drop-shadow-md">‚òÅÔ∏è Mon Cloud Personnel</h1>
        <div id="upload" class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <input type="file" id="fileInput" multiple class="mb-4 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
            <button onclick="uploadFiles()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700">Uploader</button>
        </div>
        <div id="path" class="text-lg mb-4 text-gray-700"></div>
        <div id="files" class="bg-white rounded-xl shadow-lg p-6"></div>
    </div>

    <script>
        const repo = 'lucmigmol-dev/free_cloud';
        const branch = 'main';
        const basePath = 'data/';
        let token = localStorage.getItem('githubToken');
        let currentPath = '';

        // Force le prompt au chargement si pas de token
        if (!token) {
            token = prompt('‚ö†Ô∏è Entre ton Personal Access Token GitHub (ghp_...) pour que le cloud fonctionne (list/upload/delete). Il sera stock√© seulement dans ton navigateur.');
            if (token) localStorage.setItem('githubToken', token);
            else alert('Sans token, le cloud ne peut pas lister/uploader/supprimer !');
        }

        async function listFiles(path = '') {
            if (!token) return document.getElementById('files').innerHTML = '<p class="text-red-600">Token manquant ! Recharge et entre ton PAT.</p>';
            currentPath = path;
            const fullPath = basePath + path;
            const url = `https://api.github.com/repos/${repo}/contents/${fullPath}?ref=${branch}`;
            try {
                const res = await fetch(url, {headers: {Authorization: `token ${token}`}});
                if (!res.ok) {
                    console.error('Erreur API:', res.status, await res.text());
                    return alert('Erreur API GitHub : mauvais token ou rate limit. V√©rifie console (F12).');
                }
                const data = await res.json();
                // ... (le reste du code listage identique √† avant, avec boutons T√©l√©charger et Supprimer)
                document.getElementById('path').innerHTML = `<strong>üìÇ Dossier :</strong> /data/${path || 'racine'}`;
                const container = document.getElementById('files');
                container.innerHTML = '<ul class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                if (path) {
                    const parent = path.split('/').slice(0, -2).join('/') + '/';
                    const li = document.createElement('li');
                    li.className = 'item p-4 rounded-lg bg-blue-100 text-center font-bold';
                    li.innerHTML = '‚¨ÜÔ∏è Dossier parent';
                    li.onclick = () => listFiles(parent);
                    container.querySelector('ul').appendChild(li);
                }
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'item p-4 rounded-lg bg-gray-50 border border-gray-200 flex justify-between items-center';
                    if (item.type === 'dir') {
                        li.innerHTML = `<span>üìÅ <strong>${item.name}</strong></span>`;
                        li.onclick = (e) => { if (!e.target.closest('button')) listFiles(path + item.name + '/'); };
                    } else {
                        li.innerHTML = `<span>üìÑ ${item.name} <small class="text-gray-500">(${ (item.size / 1024).toFixed(1) } KB)</small></span>
                            <div>
                                <a href="${item.download_url}" download="${item.name}" class="bg-green-600 text-white px-3 py-1 rounded mr-2 hover:bg-green-700">T√©l√©charger</a>
                                <button onclick="deleteFile('${item.path}', event)" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Supprimer</button>
                            </div>`;
                    }
                    container.querySelector('ul').appendChild(li);
                });
                container.innerHTML += '</ul>';
            } catch (err) {
                console.error('Erreur JS:', err);
                alert('Erreur JavaScript : ouvre console F12 pour d√©tails.');
            }
        }

        async function uploadFiles() {
            if (!token) return alert('Token manquant !');
            const files = document.getElementById('fileInput').files;
            for (let file of files) {
                const arrayBuffer = await file.arrayBuffer();
                const uint8 = new Uint8Array(arrayBuffer);
                let binary = '';
                uint8.forEach(byte => binary += String.fromCharCode(byte));
                const content = btoa(binary);
                const filePath = basePath + currentPath + file.name;
                await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {Authorization: `token ${token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({message: 'Upload via web', content, branch})
                });
            }
            alert('Upload termin√© ! Rafra√Æchissement...');
            listFiles(currentPath);
        }

        async function deleteFile(filePath, event) {
            event.stopPropagation();
            if (!confirm('Supprimer d√©finitivement ?')) return;
            const shaRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`, {headers: {Authorization: `token ${token}`}});
            const shaData = await shaRes.json();
            await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                method: 'DELETE',
                headers: {Authorization: `token ${token}`, 'Content-Type': 'application/json'},
                body: JSON.stringify({message: 'Delete via web', sha: shaData.sha, branch})
            });
            listFiles(currentPath);
        }

        // Chargement initial
        listFiles();
        setInterval(() => listFiles(currentPath), 5000);
    </script>
</body>
</html>