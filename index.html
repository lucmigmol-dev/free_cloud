<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Cloud - lucmigmol-dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: system-ui, sans-serif; transition: all 0.3s; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .dark .glass { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.05); }
        .item { transition: all 0.3s; }
        .item:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 min-h-screen text-white">
    <div class="container mx-auto p-6 max-w-5xl">
        <div class="flex justify-between items-center mb-12">
            <h1 class="text-5xl font-bold text-indigo-300 drop-shadow-lg">‚òÅÔ∏è Mon Cloud Personnel</h1>
            <button id="darkToggle" class="text-4xl">üåô</button>
        </div>

        <div class="glass rounded-2xl p-8 mb-8 shadow-2xl">
            <div class="flex flex-col md:flex-row gap-6">
                <input type="text" id="search" placeholder="üîç Rechercher un fichier ou dossier..." class="flex-1 px-6 py-4 rounded-xl bg-white/10 border border-white/20 focus:outline-none focus:border-indigo-400 text-lg">
                <div class="flex flex-col gap-4">
                    <input type="file" id="fileInput" multiple class="block text-sm text-gray-300 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
                    <button onclick="uploadFiles()" class="bg-indigo-600 text-white px-8 py-4 rounded-xl font-bold hover:bg-indigo-700 shadow-lg">Uploader</button>
                </div>
            </div>
        </div>

        <div id="path" class="text-xl mb-6 text-indigo-300"></div>
        <div id="files" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <script>
        const repo = 'lucmigmol-dev/free_cloud';
        const branch = 'main';
        const basePath = 'data/';
        let token = localStorage.getItem('githubToken');
        let currentPath = '';
        let allItems = [];

        if (!token) {
            token = prompt('Entre ton PAT GitHub pour les fonctionnalit√©s compl√®tes');
            if (token) localStorage.setItem('githubToken', token);
        }

        // Dark mode (forc√© dark par d√©faut, mais toggle possible)
        const darkToggle = document.getElementById('darkToggle');
        document.documentElement.classList.add('dark');
        darkToggle.textContent = '‚òÄÔ∏è';
        darkToggle.onclick = () => {
            document.documentElement.classList.toggle('dark');
            darkToggle.textContent = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        };

        // Recherche
        document.getElementById('search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            renderItems(allItems.filter(item => item.name.toLowerCase().includes(query)));
        });

        async function listFiles(path = '') {
            if (!token) return alert('Token requis');
            currentPath = path;
            const fullPath = basePath + path;
            const url = `https://api.github.com/repos/${repo}/contents/${fullPath}?ref=${branch}`;
            const res = await fetch(url, {headers: {Authorization: `token ${token}`}});
            if (!res.ok) return alert('Erreur token');
            const data = await res.json();
            // Filtre pour masquer les fichiers cach√©s (.gitkeep etc.)
            allItems = data.filter(item => !item.name.startsWith('.'));
            renderItems(allItems);
            document.getElementById('path').innerHTML = `<strong>üìÇ Dossier :</strong> /data/${path || 'racine'}`;
        }

        function renderItems(items) {
            const container = document.getElementById('files');
            container.innerHTML = '';
            if (currentPath) {
                const parent = currentPath.split('/').slice(0, -2).join('/') + '/';
                const card = createCard('‚¨ÜÔ∏è Dossier parent', '', () => listFiles(parent), true);
                container.appendChild(card);
            }
            items.forEach(item => {
                const rawLink = `https://raw.githubusercontent.com/${repo}/${branch}/${basePath}${currentPath}${item.name}`;
                if (item.type === 'dir') {
                    const card = createCard(`üìÅ ${item.name}`, '', () => listFiles(currentPath + item.name + '/'), true);
                    container.appendChild(card);
                } else {
                    const card = createCard(`üìÑ ${item.name}`, `<small class="text-gray-400">(${ (item.size / 1024).toFixed(1) } KB)</small>`,
                        null, false, rawLink, item.path);
                    container.appendChild(card);
                }
            });
        }

        function createCard(title, subtitle, onclick, isDir, shareLink, filePath) {
            const div = document.createElement('div');
            div.className = 'glass rounded-2xl p-6 shadow-xl item';
            if (onclick) div.onclick = onclick;
            div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-2xl font-bold">${title}</div>
                        ${subtitle}
                    </div>
                </div>
                ${isDir ? '' : `
                <div class="flex flex-wrap gap-3 mt-6">
                    <a href="${shareLink.replace('raw.', '')}" download="${title.split(' ')[1]}" class="bg-green-600 text-white px-5 py-2 rounded-xl hover:bg-green-700">T√©l√©charger</a>
                    <button onclick="copyShareLink('${shareLink}'); event.stopPropagation();" class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700">Partager lien</button>
                    <button onclick="deleteFile('${filePath}'); event.stopPropagation();" class="bg-red-600 text-white px-5 py-2 rounded-xl hover:bg-red-700">Supprimer</button>
                </div>`}
            `;
            return div;
        }

        function copyShareLink(link) {
            navigator.clipboard.writeText(link);
            alert('Lien copi√© : ' + link);
        }

        // Upload et Delete (robustes, m√™mes que avant)
        async function uploadFiles() {
            if (!token) return alert('Token manquant');
            const files = document.getElementById('fileInput').files;
            for (let file of files) {
                const arrayBuffer = await file.arrayBuffer();
                const uint8 = new Uint8Array(arrayBuffer);
                let binary = '';
                uint8.forEach(byte => binary += String.fromCharCode(byte));
                const content = btoa(binary);
                await fetch(`https://api.github.com/repos/${repo}/contents/${basePath}${currentPath}${file.name}`, {
                    method: 'PUT',
                    headers: {Authorization: `token ${token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({message: 'Upload web', content, branch})
                });
            }
            listFiles(currentPath);
        }

        async function deleteFile(filePath) {
            if (!confirm('Supprimer ?')) return;
            const shaRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`, {headers: {Authorization: `token ${token}`}});
            const shaData = await shaRes.json();
            await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                method: 'DELETE',
                headers: {Authorization: `token ${token}`, 'Content-Type': 'application/json'},
                body: JSON.stringify({message: 'Delete web', sha: shaData.sha, branch})
            });
            listFiles(currentPath);
        }

        listFiles();
        setInterval(() => listFiles(currentPath), 5000);
    </script>
</body>
</html>