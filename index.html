<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Cloud - lucmigmol-dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: system-ui, sans-serif; transition: background 0.3s; }
        .item { transition: all 0.2s; }
        .item:hover { transform: scale(1.02); }
        .dark { @apply bg-gray-900 text-white; }
        .dark .bg-white { @apply bg-gray-800; }
        .dark .bg-gray-50 { @apply bg-gray-700; }
        .dark .border-gray-200 { @apply border-gray-600; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-6 max-w-4xl">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-5xl font-bold text-indigo-800 dark:text-indigo-400 drop-shadow-md">â˜ï¸ Mon Cloud Personnel</h1>
            <button id="darkToggle" class="text-3xl">ğŸŒ™</button>
        </div>
        <div class="mb-6 flex gap-4">
            <input type="text" id="search" placeholder="ğŸ” Rechercher un fichier..." class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:bg-gray-800 dark:border-gray-600">
            <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                <input type="file" id="fileInput" multiple class="mb-4 block text-sm text-gray-900 dark:text-gray-200">
                <button onclick="uploadFiles()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700">Uploader</button>
            </div>
        </div>
        <div id="path" class="text-lg mb-4 text-gray-700 dark:text-gray-300"></div>
        <div id="files" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"></div>
    </div>

    <script>
        const repo = 'lucmigmol-dev/free_cloud';
        const branch = 'main';
        const basePath = 'data/';
        let token = localStorage.getItem('githubToken');
        let currentPath = '';
        let allItems = [];

        if (!token) {
            token = prompt('Entre ton PAT GitHub (ghp_...) pour full fonctionnalitÃ©s');
            if (token) localStorage.setItem('githubToken', token);
        }

        // Dark mode toggle
        const darkToggle = document.getElementById('darkToggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (localStorage.getItem('darkMode') === 'true' || (localStorage.getItem('darkMode') === null && prefersDark)) {
            document.documentElement.classList.add('dark');
            darkToggle.textContent = 'â˜€ï¸';
        }
        darkToggle.onclick = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            darkToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('darkMode', isDark);
        };

        // Recherche
        document.getElementById('search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            renderItems(allItems.filter(item => item.name.toLowerCase().includes(query)));
        });

        async function listFiles(path = '') {
            if (!token) return alert('Token requis pour lister !');
            currentPath = path;
            const fullPath = basePath + path;
            const url = `https://api.github.com/repos/${repo}/contents/${fullPath}?ref=${branch}`;
            const res = await fetch(url, {headers: {Authorization: `token ${token}`}});
            if (!res.ok) return alert('Erreur token ou connexion');
            const data = await res.json();
            allItems = data;
            renderItems(data);
            document.getElementById('path').innerHTML = `<strong>ğŸ“‚ Dossier :</strong> /data/${path || 'racine'}`;
        }

        function renderItems(items) {
            const container = document.getElementById('files');
            container.innerHTML = '<ul class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            if (currentPath) {
                const parent = currentPath.split('/').slice(0, -2).join('/') + '/';
                const li = document.createElement('li');
                li.className = 'p-4 rounded-lg bg-blue-100 dark:bg-blue-900 text-center font-bold';
                li.innerHTML = 'â¬†ï¸ Dossier parent';
                li.onclick = () => listFiles(parent);
                container.querySelector('ul').appendChild(li);
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-4 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 flex justify-between items-center item';
                if (item.type === 'dir') {
                    li.innerHTML = `<span>ğŸ“ <strong>${item.name}</strong></span>`;
                    li.onclick = () => listFiles(currentPath + item.name + '/');
                } else {
                    const rawLink = `https://raw.githubusercontent.com/${repo}/${branch}/${basePath}${currentPath}${item.name}`;
                    li.innerHTML = `<span>ğŸ“„ ${item.name} <small class="text-gray-500 dark:text-gray-400">(${ (item.size / 1024).toFixed(1) } KB)</small></span>
                        <div class="flex gap-2">
                            <a href="${item.download_url}" download="${item.name}" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">TÃ©lÃ©charger</a>
                            <button onclick="copyShareLink('${rawLink}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Partager lien</button>
                            <button onclick="deleteFile('${item.path}', event)" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Supprimer</button>
                        </div>`;
                }
                container.querySelector('ul').appendChild(li);
            });
            container.innerHTML += '</ul>';
        }

        function copyShareLink(link) {
            navigator.clipboard.writeText(link);
            alert('Lien copiÃ© ! ' + link);
        }

        // Upload & Delete inchangÃ©s (robustes comme avant)
        async function uploadFiles() { /* mÃªme code upload que version prÃ©cÃ©dente avec arrayBuffer */ }
        async function deleteFile(filePath, event) { /* mÃªme code delete que avant */ }

        listFiles();
        setInterval(() => listFiles(currentPath), 5000);
    </script>
</body>
</html>