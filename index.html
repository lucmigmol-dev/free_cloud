#!/data/data/com.termux/files/usr/bin/bash

# Installation notification si pas fait (une fois)
pkg install termux-api > /dev/null 2>&1

REPO_PATH="/storage/emulated/0/MonCloud/free_cloud"

cd "$REPO_PATH" || { echo "Erreur : dossier repo introuvable !"; exit 1; }

echo "üöÄ Auto-sync mobile d√©marr√© ! (Ctrl+C pour arr√™ter)"
termux-notification --title "Mon Cloud Sync" --content "Sync auto lanc√© sur t√©l√©phone" --ongoing

while true; do
    echo "$(date +'%H:%M:%S') - üîÑ Tentative de sync..."

    # Pull changements distants
    PULL_OUTPUT=$(git pull origin main 2>&1)
    if echo "$PULL_OUTPUT" | grep -q "Already up to date"; then
        echo "   ‚úì Pull : d√©j√† √† jour"
    elif echo "$PULL_OUTPUT" | grep -q "Fast-forward\|Updating"; then
        echo "   ‚úÖ Pull : nouveaux fichiers re√ßus !"
        termux-notification --title "Mon Cloud" --content "Nouveaux fichiers synchronis√©s depuis distant"
    elif echo "$PULL_OUTPUT" | grep -q "CONFLICT"; then
        echo "   ‚ö†Ô∏è Conflit d√©tect√© ! R√©sous manuellement"
        termux-notification --title "Mon Cloud ‚ö†Ô∏è" --content "Conflit Git - v√©rifie le dossier"
    else
        echo "   ‚ö†Ô∏è Pull : $PULL_OUTPUT"
    fi

    # V√©rifie changements locaux
    STATUS=$(git status --porcelain)
    if [ -n "$STATUS" ]; then
        echo "   üìÅ Changements locaux d√©tect√©s (ajout/modif/suppr)"

        git add .
        git commit -m "Auto-sync mobile $(date +'%Y-%m-%d %H:%M:%S')" > /dev/null 2>&1

        PUSH_OUTPUT=$(git push origin main 2>&1)
        if [ $? -eq 0 ]; then
            echo "   ‚úÖ Push : changements envoy√©s avec succ√®s !"
            termux-notification --title "Mon Cloud" --content "Fichiers ajout√©s/modifi√©s synchronis√©s vers GitHub"
        else
            echo "   ‚ùå Push √©chou√© : $PUSH_OUTPUT"
            termux-notification --title "Mon Cloud ‚ö†Ô∏è" --content "Erreur push - v√©rifie connexion/PAT"
        fi
    else
        echo "   ‚úì Pas de changements locaux"
    fi

    echo "   üò¥ Attente 10 secondes..."
    sleep 10
done